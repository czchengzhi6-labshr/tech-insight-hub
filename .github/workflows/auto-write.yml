name: Auto Tech Article Writer

on:
  schedule:
    - cron: "0 */4 * * *"   # ÊØè4Â∞èÊó∂ËøêË°å
  workflow_dispatch: {}

jobs:
  write_article:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install axios only
        run: npm install axios

      - name: Generate Tech Article + Cover Image
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          node << 'EOF'
          const axios = require("axios");
          const fs = require("fs");
          const path = require("path");

          async function generateArticle() {
            console.log("üìù Generating tech article...");

            const prompt = `
Write a high-quality English technology article (1000‚Äì1500 words).
Include ONE placeholder for advertisement:

---ADVERTISEMENT-BLOCK---

Do NOT wrap content in code fences.
            `;

            const res = await axios.post(
              "https://api.deepseek.com/v1/chat/completions",
              {
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: "You are a professional technology columnist." },
                  { role: "user", content: prompt }
                ]
              },
              {
                headers: {
                  "Authorization": "Bearer " + process.env.DEEPSEEK_API_KEY,
                  "Content-Type": "application/json"
                }
              }
            );

            return res.data.choices[0].message.content;
          }

          async function generateCover() {
            const url = "https://picsum.photos/1200/630";
            const buffer = (await axios.get(url, {responseType:"arraybuffer"})).data;

            const filename = `cover_${Date.now()}.jpg`;
            if (!fs.existsSync("covers")) fs.mkdirSync("covers");
            fs.writeFileSync(path.join("covers", filename), buffer);

            return filename;
          }

          async function main() {
            if (!fs.existsSync("articles")) fs.mkdirSync("articles");

            const article = await generateArticle();
            const cover = await generateCover();

            const file = `article_${Date.now()}.html`;

            const html = `
<html>
<head><meta charset="UTF-8"><title>Tech Article</title></head>
<body>
<img src="../covers/${cover}" style="width:100%; border-radius:12px;">

<h1>AI Generated Tech Article</h1>
${article.replace(/\n/g, "<br>")}

<br><br><div class="ad">AD SPACE</div>
</body></html>
            `;

            fs.writeFileSync(path.join("articles", file), html);

            let list = [];
            if (fs.existsSync("article-list.json")) {
              list = JSON.parse(fs.readFileSync("article-list.json"));
            }

            list.push({
              title: "AI Tech Article",
              file,
              cover,
              timestamp: Date.now()
            });

            fs.writeFileSync("article-list.json", JSON.stringify(list, null, 2));
          }

          main();
          EOF

      - name: Commit & Push
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          git commit -m "Auto article" || echo "No changes"
          git push
